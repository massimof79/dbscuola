<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Studenti</title>
</head>
<body>

<h2>Elenco Studenti</h2>

<table border="1" id="tabella">
  <thead>
    <tr>
      <th>ID</th>
      <th>Cognome</th>
      <th>Nome</th>
      <th>Data nascita</th>
      <th>Classe</th>
      <th>Salva</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p id="msg"></p>

<script>
const tbody = document.querySelector("#tabella tbody");
const msg = document.getElementById("msg");

async function caricaStudenti(){
  const res = await fetch("get_studenti.php");
  const data = await res.json();

  tbody.innerHTML = "";

  data.studenti.forEach(s => {
    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${s.id_studente}</td>
      <td contenteditable data-field="cognome">${s.cognome ?? ""}</td>
      <td contenteditable data-field="nome">${s.nome ?? ""}</td>
      <td contenteditable data-field="data_nascita">${s.data_nascita ?? ""}</td>
      <td contenteditable data-field="id_classe">${s.id_classe ?? ""}</td>
      <td><button onclick="salva(this)">Salva</button></td>
    `;

    tr.dataset.id = s.id_studente;
    tbody.appendChild(tr);
  });
}

async function salva(btn){
  let tr = btn.parentElement.parentElement;

  let dati = {
    id_studente: tr.dataset.id
  };

  tr.querySelectorAll("[data-field]").forEach(td => {
    dati[td.dataset.field] = td.innerText;
  });

  const res = await fetch("update_studente.php", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(dati)
  });

  const result = await res.json();
  msg.innerText = result.message;
}

caricaStudenti();
</script>

</body>
</html>
